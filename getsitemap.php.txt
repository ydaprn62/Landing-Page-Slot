<?php

// Fungsi untuk menghitung jumlah baris dalam file
function getFileRowCount($filename)
{
    if (!file_exists($filename)) {
        return 0;
    }
    return count(file($filename, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES));
}

// Fungsi untuk otomatis rank keywords berdasarkan file brandlist.txt
function autoRankKeywords($target_string)
{
    $filename = "brandlist.txt";

    // Pastikan file brandlist.txt ada
    if (!file_exists($filename)) {
        return null; // Kembalikan null jika file tidak ada
    }

    // Baca semua kata kunci dari file brandlist.txt
    $fileLines = file($filename, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

    // Cek apakah kata kunci target ada dalam daftar file
    foreach ($fileLines as $line) {
        if (strtolower(trim($line)) == strtolower($target_string)) {
            return strtoupper(trim($line)); // Jika ditemukan, ubah menjadi uppercase untuk optimisasi
        }
    }

    return null; // Jika tidak ditemukan, kembalikan null
}

$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'https';  // Fixed protocol to 'https'
$fullUrl = $protocol . "://" . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

if (isset($fullUrl)) {
    $parsedUrl = parse_url($fullUrl);
    $scheme = $parsedUrl['scheme'] ?? '';
    $host = $parsedUrl['host'] ?? '';
    $path = dirname($parsedUrl['path']);
    $urlAsli = $scheme . "://" . $host . $path . '/';

    $judulFile = "brandlist.txt";
    if (!file_exists($judulFile)) {
        echo "File brandlist.txt tidak ditemukan!";
        exit();
    }

    $jumlahBaris = getFileRowCount($judulFile);
    if ($jumlahBaris === 0) {
        echo "File brandlist.txt kosong!";
        exit();
    }

    $fileLines = file($judulFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $itemsPerPage = 1000;
    $totalPages = ceil($jumlahBaris / $itemsPerPage);

    // Buat sitemap index
    $sitemapIndexFile = fopen("sitemap-index.xml", "w");
    fwrite($sitemapIndexFile, '<?xml version="1.0" encoding="UTF-8"?>' . PHP_EOL);
    fwrite($sitemapIndexFile, '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . PHP_EOL);

    // Loop untuk membuat sitemap per halaman
    for ($i = 0; $i < $totalPages; $i++) {
        $start = $i * $itemsPerPage;
        $slice = array_slice($fileLines, $start, $itemsPerPage);
        $sitemapFileName = "sitemap-" . ($i + 1) . ".xml";

        $sitemapFile = fopen($sitemapFileName, "w");
        fwrite($sitemapFile, '<?xml version="1.0" encoding="UTF-8"?>' . PHP_EOL);
        fwrite($sitemapFile, '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . PHP_EOL);

        // Menambahkan URL dengan kata kunci yang sudah dioptimalkan
        foreach ($slice as $judul) {
            // Cek dan optimalkan kata kunci
            $optimizedKeyword = autoRankKeywords($judul);
            if ($optimizedKeyword) {
                $sitemapLink = $urlAsli . '?ngaceng=' . urlencode($optimizedKeyword);
            } else {
                $sitemapLink = $urlAsli . '?ngaceng=' . urlencode($judul);
            }

            fwrite($sitemapFile, '  <url>' . PHP_EOL);
            fwrite($sitemapFile, '    <loc>' . htmlspecialchars($sitemapLink) . '</loc>' . PHP_EOL);
            date_default_timezone_set('Asia/Jakarta');
            $currentTime = date('Y-m-d\TH:i:sP');
            fwrite($sitemapFile, '    <lastmod>' . $currentTime . '</lastmod>' . PHP_EOL);
            fwrite($sitemapFile, '    <changefreq>daily</changefreq>' . PHP_EOL);
            fwrite($sitemapFile, '    <priority>0.8</priority>' . PHP_EOL);
            fwrite($sitemapFile, '  </url>' . PHP_EOL);
        }

        fwrite($sitemapFile, '</urlset>' . PHP_EOL);
        fclose($sitemapFile);

        // Menambahkan sitemap ke index sitemap
        fwrite($sitemapIndexFile, '  <sitemap>' . PHP_EOL);
        fwrite($sitemapIndexFile, '    <loc>' . htmlspecialchars($urlAsli . $sitemapFileName) . '</loc>' . PHP_EOL);
        fwrite($sitemapIndexFile, '    <lastmod>' . $currentTime . '</lastmod>' . PHP_EOL);
        fwrite($sitemapIndexFile, '  </sitemap>' . PHP_EOL);
    }

    fwrite($sitemapIndexFile, '</sitemapindex>' . PHP_EOL);
    fclose($sitemapIndexFile);

    // Create robots.txt dynamically
    $robotsFile = fopen("robots.txt", "w");
    fwrite($robotsFile, "User-agent: *" . PHP_EOL);
    fwrite($robotsFile, "Disallow: /" . PHP_EOL);
    fwrite($robotsFile, "Sitemap: " . $urlAsli . "sitemap-index.xml" . PHP_EOL);
    fclose($robotsFile);

    // Notifikasi hanya lewat teks
    echo "Sitemap and robots.txt have been successfully created.\n";
    echo "Total Pages: " . $totalPages . "\n";
} else {
    echo "URL saat ini tidak didefinisikan.";
}

?>
